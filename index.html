<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>J.A.R.V.I.S.</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--blue:#00d4ff;--orange:#ff6600;--bg:#0a0a0f;--panel:rgba(0,212,255,0.05);--glow:0 0 20px rgba(0,212,255,0.5)}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes glowPulse{0%,100%{text-shadow:0 0 20px var(--blue),0 0 40px var(--blue),0 0 80px rgba(0,212,255,0.3)}50%{text-shadow:0 0 30px var(--blue),0 0 60px var(--blue),0 0 120px rgba(0,212,255,0.5)}}
@keyframes bootLine{from{width:0}to{width:100%}}
@keyframes scanline{0%{top:-10%}100%{top:110%}}
body{background:var(--bg);color:var(--blue);font-family:'Courier New',monospace;overflow:hidden;height:100vh;width:100vw;user-select:none}
/* Boot Screen */
#boot-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s}
#boot-screen.hidden{opacity:0;pointer-events:none}
.boot-text{font-size:14px;color:var(--blue);opacity:0;margin:4px 0;white-space:nowrap;font-family:'Courier New',monospace}
.boot-text.show{animation:fadeInUp .3s forwards}
#boot-logo{font-size:60px;letter-spacing:20px;font-weight:bold;color:var(--blue);opacity:0;margin-bottom:40px;text-shadow:0 0 30px var(--blue)}
#boot-logo.show{opacity:1;animation:glowPulse 2s infinite}
.boot-bar{width:300px;height:2px;background:rgba(0,212,255,0.1);margin-top:30px;overflow:hidden;border-radius:1px}
.boot-bar-fill{height:100%;width:0;background:var(--blue);box-shadow:0 0 10px var(--blue);transition:width .3s}
/* Scanline */
.scanline{position:fixed;top:-10%;left:0;width:100%;height:8%;background:linear-gradient(transparent,rgba(0,212,255,0.03),transparent);z-index:1;pointer-events:none;animation:scanline 8s linear infinite}
/* Grid BG */
#grid-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.15}
/* Main UI */
#app{display:none;height:100vh;flex-direction:column;align-items:center;position:relative;z-index:2}
#app.show{display:flex}
/* Header */
.header{text-align:center;padding:30px 0 10px;position:relative;z-index:10}
.header h1{font-size:48px;letter-spacing:16px;font-weight:bold;animation:glowPulse 3s infinite}
.status-line{font-size:13px;color:var(--blue);opacity:.7;margin-top:8px;height:20px;letter-spacing:4px}
/* Arc Reactor */
.reactor-wrap{position:relative;width:320px;height:320px;margin:10px auto}
#visualizer{width:320px;height:320px;position:relative;z-index:2}
.reactor-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;border:1px solid rgba(0,212,255,0.15)}
.reactor-ring:nth-child(2){width:340px;height:340px;animation:spin 30s linear infinite}
.reactor-ring:nth-child(3){width:360px;height:360px;animation:spin 45s linear infinite reverse}
.reactor-ring:nth-child(4){width:380px;height:380px;animation:spin 60s linear infinite}
/* HUD decorations */
.hud-line{position:fixed;background:rgba(0,212,255,0.08);z-index:1}
.hud-h{height:1px;width:100%}.hud-v{width:1px;height:100%}
.hud-corner{position:fixed;width:60px;height:60px;border:1px solid rgba(0,212,255,0.12);z-index:1}
.hud-corner.tl{top:20px;left:20px;border-right:0;border-bottom:0}
.hud-corner.tr{top:20px;right:20px;border-left:0;border-bottom:0}
.hud-corner.bl{bottom:20px;left:20px;border-right:0;border-top:0}
.hud-corner.br{bottom:20px;right:20px;border-left:0;border-top:0}
/* Transcript */
.transcript-area{text-align:center;min-height:60px;max-width:700px;margin:10px auto;padding:0 20px;position:relative;z-index:10}
.transcript-current{font-size:18px;color:#fff;opacity:.9;line-height:1.5;min-height:30px}
.transcript-interim{font-size:16px;color:var(--blue);opacity:.5;font-style:italic;min-height:24px}
/* Controls */
.controls{display:flex;align-items:center;gap:20px;margin-top:auto;padding-bottom:40px;position:relative;z-index:10}
#ptt-btn{width:80px;height:80px;border-radius:50%;border:2px solid var(--blue);background:rgba(0,212,255,0.08);cursor:pointer;position:relative;transition:all .2s;display:flex;align-items:center;justify-content:center}
#ptt-btn:hover{background:rgba(0,212,255,0.15);box-shadow:var(--glow)}
#ptt-btn.active{background:rgba(0,212,255,0.25);box-shadow:0 0 30px var(--blue);border-color:#fff}
#ptt-btn.active .mic-icon{fill:#fff}
.mic-icon{width:28px;height:28px;fill:var(--blue);transition:fill .2s}
#always-listen-btn{width:44px;height:44px;border-radius:50%;border:1px solid rgba(0,212,255,0.3);background:transparent;cursor:pointer;color:var(--blue);font-size:11px;letter-spacing:1px;transition:all .2s;display:flex;align-items:center;justify-content:center}
#always-listen-btn.active{background:rgba(255,102,0,0.2);border-color:var(--orange);color:var(--orange)}
#settings-btn{width:44px;height:44px;border-radius:50%;border:1px solid rgba(0,212,255,0.3);background:transparent;cursor:pointer;color:var(--blue);font-size:20px;transition:all .2s;display:flex;align-items:center;justify-content:center}
#settings-btn:hover{border-color:var(--blue);box-shadow:var(--glow)}
/* Conversation panel */
#convo-panel{position:fixed;right:0;top:0;width:360px;height:100vh;background:rgba(10,10,15,0.95);border-left:1px solid rgba(0,212,255,0.1);z-index:20;transform:translateX(100%);transition:transform .3s;overflow-y:auto;padding:20px 16px}
#convo-panel.open{transform:translateX(0)}
#convo-toggle{position:fixed;right:16px;top:50%;transform:translateY(-50%);width:30px;height:60px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-right:0;border-radius:8px 0 0 8px;cursor:pointer;z-index:21;display:flex;align-items:center;justify-content:center;color:var(--blue);font-size:14px;transition:right .3s}
#convo-toggle.shifted{right:376px}
.convo-title{font-size:12px;letter-spacing:4px;opacity:.5;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid rgba(0,212,255,0.1)}
.msg{margin-bottom:14px;animation:fadeInUp .3s;font-size:13px;line-height:1.5}
.msg.user{color:var(--orange);padding-left:12px;border-left:2px solid var(--orange)}
.msg.assistant{color:var(--blue);padding-left:12px;border-left:2px solid var(--blue)}
.msg-role{font-size:10px;letter-spacing:2px;opacity:.5;margin-bottom:2px}
/* Settings */
#settings-panel{position:fixed;inset:0;background:rgba(10,10,15,0.92);z-index:100;display:none;align-items:center;justify-content:center}
#settings-panel.open{display:flex}
.settings-box{background:rgba(0,212,255,0.03);border:1px solid rgba(0,212,255,0.15);padding:40px;border-radius:4px;width:400px;max-width:90vw}
.settings-box h2{font-size:14px;letter-spacing:4px;margin-bottom:24px;color:var(--blue)}
.settings-box label{display:block;font-size:11px;letter-spacing:2px;opacity:.6;margin-bottom:6px;margin-top:16px}
.settings-box input,.settings-box select{width:100%;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);color:var(--blue);padding:10px;font-family:inherit;font-size:13px;border-radius:2px}
.settings-box input:focus,.settings-box select:focus{outline:none;border-color:var(--blue);box-shadow:var(--glow)}
.settings-box select option{background:var(--bg)}
.btn-row{display:flex;gap:12px;margin-top:24px}
.btn-row button{flex:1;padding:10px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);color:var(--blue);font-family:inherit;font-size:12px;letter-spacing:2px;cursor:pointer;border-radius:2px;transition:all .2s}
.btn-row button:hover{background:rgba(0,212,255,0.2);box-shadow:var(--glow)}
/* Particles */
#particle-canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
/* Thinking dots */
.thinking-dots span{display:inline-block;animation:pulse 1.2s infinite;margin:0 2px}
.thinking-dots span:nth-child(2){animation-delay:.2s}
.thinking-dots span:nth-child(3){animation-delay:.4s}
</style>
</head>
<body>
<!-- Boot Screen -->
<div id="boot-screen">
  <div id="boot-logo">J.A.R.V.I.S.</div>
  <div id="boot-lines"></div>
  <div class="boot-bar"><div class="boot-bar-fill" id="boot-bar-fill"></div></div>
</div>

<!-- Main App -->
<div id="app">
  <div class="scanline"></div>
  <canvas id="particle-canvas"></canvas>
  <canvas id="grid-canvas"></canvas>
  <div class="hud-corner tl"></div><div class="hud-corner tr"></div>
  <div class="hud-corner bl"></div><div class="hud-corner br"></div>

  <div class="header">
    <h1>J.A.R.V.I.S.</h1>
    <div class="status-line" id="status">SYSTEMS ONLINE</div>
  </div>

  <div class="reactor-wrap">
    <canvas id="visualizer" width="320" height="320"></canvas>
    <div class="reactor-ring"></div>
    <div class="reactor-ring"></div>
    <div class="reactor-ring"></div>
  </div>

  <div class="transcript-area">
    <div class="transcript-current" id="transcript-current"></div>
    <div class="transcript-interim" id="transcript-interim"></div>
  </div>

  <div class="controls">
    <button id="always-listen-btn" title="Always Listen">AUTO</button>
    <input id="text-input" type="text" placeholder="Type here..." style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.3);color:var(--blue);font-family:'Courier New',monospace;font-size:14px;padding:8px 12px;border-radius:20px;outline:none;width:200px;margin-left:10px" />
    <button id="ptt-btn" title="Push to Talk (or hold Space)">
      <svg class="mic-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>
    <button id="settings-btn" title="Settings">⚙</button>
  </div>
</div>

<!-- Conversation Panel -->
<div id="convo-toggle" onclick="toggleConvo()">◀</div>
<div id="convo-panel">
  <div class="convo-title">CONVERSATION LOG</div>
  <div id="convo-messages"></div>
</div>

<!-- Settings Panel -->
<div id="settings-panel">
  <div class="settings-box">
    <h2>CONFIGURATION</h2>
    <label>OPENAI API KEY</label>
    <input type="password" id="api-key-input" placeholder="sk-...">
    <label>TTS VOICE</label>
    <select id="voice-select">
      <option value="onyx">Onyx (Deep)</option>
      <option value="alloy">Alloy</option>
      <option value="echo">Echo</option>
      <option value="fable">Fable</option>
      <option value="nova">Nova</option>
      <option value="shimmer">Shimmer</option>
    </select>
    <label>CHAT MODEL</label>
    <select id="model-select">
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4o-mini">GPT-4o Mini</option>
      <option value="gpt-4-turbo">GPT-4 Turbo</option>
    </select>
    <div class="btn-row">
      <button onclick="saveSettings()">SAVE</button>
      <button onclick="closeSettings()">CANCEL</button>
    </div>
  </div>
</div>

<script>
// ─── State ───
const S = {
  apiKey: localStorage.getItem('jarvis_api_key') || '',
  voice: localStorage.getItem('jarvis_voice') || 'onyx',
  model: localStorage.getItem('jarvis_model') || 'gpt-4o',
  messages: [{role:'system',content:'You are Jarvis, an advanced AI assistant. You are intelligent, witty, slightly sardonic, and deeply competent. Respond conversationally and concisely — you\'re speaking out loud, not writing essays. Keep responses under 3 sentences unless asked for detail.'}],
  isSpeaking: false,
  isListening: false,
  isThinking: false,
  alwaysListen: false,
  pttDown: false,
  audioCtx: null,
  analyser: null,
  micAnalyser: null,
  micSource: null,
  recognition: null,
};

// ─── DOM ───
const $=id=>document.getElementById(id);
const statusEl=$('status'), currentEl=$('transcript-current'), interimEl=$('transcript-interim');
const canvas=$('visualizer'), ctx=canvas.getContext('2d');
const pttBtn=$('ptt-btn'), alBtn=$('always-listen-btn'), settingsBtn=$('settings-btn');
const convoPanel=$('convo-panel'), convoToggle=$('convo-toggle'), convoMsgs=$('convo-messages');

// ─── Audio Context ───
function ensureAudio(){
  if(!S.audioCtx){
    S.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    S.analyser=S.audioCtx.createAnalyser();
    S.analyser.fftSize=256;
  }
}

// ─── Boot Sequence ───
(async function boot(){
  const lines=['Initializing core systems...','Loading neural interface...','Calibrating voice synthesis...','Establishing API connections...','Running diagnostics...','All systems nominal.','Welcome, sir.'];
  const container=$('boot-lines');
  const logo=$('boot-logo');
  const bar=$('boot-bar-fill');
  await delay(500);
  logo.classList.add('show');
  await delay(800);
  for(let i=0;i<lines.length;i++){
    const el=document.createElement('div');
    el.className='boot-text';
    el.textContent='> '+lines[i];
    container.appendChild(el);
    await delay(100);
    el.classList.add('show');
    bar.style.width=((i+1)/lines.length*100)+'%';
    await delay(300);
  }
  await delay(800);
  $('boot-screen').classList.add('hidden');
  await delay(500);
  $('app').classList.add('show');
  initParticles();
  initGrid();
  startVisualizer();
  initSpeechRecognition();
  playTone(880,.08,.1);
  setTimeout(()=>playTone(1100,.08,.1),120);
  if(!S.apiKey)setTimeout(()=>openSettings(),1000);
})();

function delay(ms){return new Promise(r=>setTimeout(r,ms))}

// ─── Sound Effects ───
function playTone(freq,dur,vol=.05){
  ensureAudio();
  const o=S.audioCtx.createOscillator(),g=S.audioCtx.createGain();
  o.type='sine';o.frequency.value=freq;
  g.gain.setValueAtTime(vol,S.audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,S.audioCtx.currentTime+dur);
  o.connect(g);g.connect(S.audioCtx.destination);
  o.start();o.stop(S.audioCtx.currentTime+dur);
}

// ─── Settings ───
function openSettings(){
  $('api-key-input').value=S.apiKey;
  $('voice-select').value=S.voice;
  $('model-select').value=S.model;
  $('settings-panel').classList.add('open');
}
function closeSettings(){$('settings-panel').classList.remove('open')}
function saveSettings(){
  S.apiKey=$('api-key-input').value.trim();
  S.voice=$('voice-select').value;
  S.model=$('model-select').value;
  localStorage.setItem('jarvis_api_key',S.apiKey);
  localStorage.setItem('jarvis_voice',S.voice);
  localStorage.setItem('jarvis_model',S.model);
  closeSettings();
  playTone(1200,.1);
  setStatus('CONFIGURATION SAVED');
}
settingsBtn.onclick=openSettings;

// ─── Conversation Panel ───
function toggleConvo(){
  convoPanel.classList.toggle('open');
  convoToggle.classList.toggle('shifted');
  convoToggle.textContent=convoPanel.classList.contains('open')?'▶':'◀';
}

function addConvoMessage(role,text){
  const d=document.createElement('div');
  d.className='msg '+role;
  d.innerHTML=`<div class="msg-role">${role==='user'?'YOU':'JARVIS'}</div>${text}`;
  convoMsgs.appendChild(d);
  convoMsgs.scrollTop=convoMsgs.scrollHeight;
}

// ─── Status ───
function setStatus(t){statusEl.textContent=t}

// ─── Speech Recognition ───
function initSpeechRecognition(){
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
    setStatus('SPEECH API NOT SUPPORTED');return;
  }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  S.recognition=new SR();
  S.recognition.continuous=true;
  S.recognition.interimResults=true;
  S.recognition.lang='en-US';
  let finalText='';
  S.recognition.onresult=e=>{
    let interim='',final='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal)final+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    if(final){finalText+=final;currentEl.textContent=finalText;}
    interimEl.textContent=interim;
  };
  S.recognition.onend=()=>{
    S.isListening=false;
    pttBtn.classList.remove('active');
    if(finalText.trim()&&!S.isThinking&&!S.isSpeaking){
      sendToAI(finalText.trim());
      finalText='';
    }
    if(S.alwaysListen&&!S.isSpeaking&&!S.isThinking){
      setTimeout(()=>startListening(),300);
    }
  };
  S.recognition.onerror=e=>{
    console.log('Speech error:',e.error);
    if(e.error!=='no-speech'&&e.error!=='aborted')setStatus('MIC ERROR: '+e.error);
  };
  S.recognition.onstart=()=>console.log('Recognition started');
  S.recognition.onaudiostart=()=>console.log('Audio capture started');
  S.recognition.onspeechstart=()=>console.log('Speech detected');
  S.recognition.onspeechend=()=>console.log('Speech ended');
}

function startListening(){
  if(S.isListening||S.isSpeaking||S.isThinking)return;
  ensureAudio();
  S.isListening=true;
  pttBtn.classList.add('active');
  currentEl.textContent='';
  interimEl.textContent='';
  setStatus('LISTENING...');
  playTone(600,.06);
  // Mic analyser
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    S.micSource=S.audioCtx.createMediaStreamSource(stream);
    S.micAnalyser=S.audioCtx.createAnalyser();
    S.micAnalyser.fftSize=256;
    S.micSource.connect(S.micAnalyser);
    S._micStream=stream;
  }).catch(()=>{});
  try{S.recognition.start()}catch(e){}
}

function stopListening(){
  if(!S.isListening)return;
  try{S.recognition.stop()}catch(e){}
  S.isListening=false;
  pttBtn.classList.remove('active');
  playTone(400,.06);
  if(S._micStream){S._micStream.getTracks().forEach(t=>t.stop());S._micStream=null;}
  S.micSource=null;S.micAnalyser=null;
  if(!S.isThinking)setStatus('SYSTEMS ONLINE');
}

// PTT button
pttBtn.onmousedown=()=>{if(!S.alwaysListen)startListening()};
pttBtn.onmouseup=()=>{if(!S.alwaysListen)stopListening()};
pttBtn.onmouseleave=()=>{if(!S.alwaysListen&&S.isListening)stopListening()};
// Touch
pttBtn.ontouchstart=e=>{e.preventDefault();if(!S.alwaysListen)startListening()};
pttBtn.ontouchend=e=>{e.preventDefault();if(!S.alwaysListen)stopListening()};

// Spacebar
document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&!e.repeat&&!$('settings-panel').classList.contains('open')&&document.activeElement.tagName!=='INPUT'){
    e.preventDefault();if(!S.alwaysListen)startListening();
  }
});
document.addEventListener('keyup',e=>{
  if(e.code==='Space'&&!$('settings-panel').classList.contains('open')&&document.activeElement.tagName!=='INPUT'){
    e.preventDefault();if(!S.alwaysListen)stopListening();
  }
});

// Text input fallback
$('text-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.target.value.trim()){
    sendToAI(e.target.value.trim());
    e.target.value='';
  }
});

// Always Listen toggle
alBtn.onclick=()=>{
  S.alwaysListen=!S.alwaysListen;
  alBtn.classList.toggle('active',S.alwaysListen);
  if(S.alwaysListen){startListening();}
  else{stopListening();}
};

// ─── AI Chat ───
async function sendToAI(text){
  if(!S.apiKey){openSettings();setStatus('API KEY REQUIRED');return;}
  S.isThinking=true;
  setStatus('THINKING...');
  currentEl.innerHTML='<span class="thinking-dots"><span>●</span><span>●</span><span>●</span></span>';
  interimEl.textContent='';
  S.messages.push({role:'user',content:text});
  addConvoMessage('user',text);
  try{
    const res=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+S.apiKey},
      body:JSON.stringify({model:S.model,messages:S.messages,max_tokens:300})
    });
    if(!res.ok)throw new Error('API '+res.status);
    const data=await res.json();
    const reply=data.choices[0].message.content;
    S.messages.push({role:'assistant',content:reply});
    addConvoMessage('assistant',reply);
    currentEl.textContent=reply;
    S.isThinking=false;
    await speakText(reply);
  }catch(e){
    S.isThinking=false;
    setStatus('ERROR: '+e.message);
    currentEl.textContent='Connection error. Check API key and try again.';
    if(S.alwaysListen)setTimeout(()=>startListening(),1000);
  }
}

// ─── TTS ───
async function speakText(text){
  if(!S.apiKey)return;
  S.isSpeaking=true;
  setStatus('SPEAKING...');
  try{
    const res=await fetch('https://api.openai.com/v1/audio/speech',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+S.apiKey},
      body:JSON.stringify({model:'tts-1',input:text,voice:S.voice,response_format:'mp3'})
    });
    if(!res.ok)throw new Error('TTS '+res.status);
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const audio=new Audio(url);
    ensureAudio();
    const source=S.audioCtx.createMediaElementSource(audio);
    S.analyser=S.audioCtx.createAnalyser();
    S.analyser.fftSize=256;
    source.connect(S.analyser);
    S.analyser.connect(S.audioCtx.destination);
    await new Promise((resolve,reject)=>{
      audio.onended=resolve;
      audio.onerror=reject;
      audio.play().catch(reject);
    });
    URL.revokeObjectURL(url);
  }catch(e){
    console.error('TTS error',e);
  }
  S.isSpeaking=false;
  S.analyser=S.audioCtx.createAnalyser();S.analyser.fftSize=256;
  setStatus('SYSTEMS ONLINE');
  if(S.alwaysListen)setTimeout(()=>startListening(),500);
}

// ─── Visualizer ───
function startVisualizer(){
  const W=320,H=320,cx=W/2,cy=H/2;
  let t=0;
  function draw(){
    requestAnimationFrame(draw);
    ctx.clearRect(0,0,W,H);
    t+=0.02;
    const data=new Uint8Array(128);
    const analyser=S.isSpeaking?S.analyser:(S.isListening&&S.micAnalyser?S.micAnalyser:null);
    if(analyser){try{analyser.getByteFrequencyData(data)}catch(e){}}
    // Outer rings
    for(let r=0;r<3;r++){
      ctx.beginPath();
      const baseR=80+r*18;
      ctx.strokeStyle=`rgba(0,212,255,${0.08-r*0.02})`;
      ctx.lineWidth=1;
      for(let i=0;i<=360;i+=2){
        const a=i*Math.PI/180;
        const idx=Math.floor(i/360*128);
        const amp=analyser?(data[idx]||0)/255*20:Math.sin(t*2+i*0.05)*3;
        const rd=baseR+amp;
        const x=cx+Math.cos(a)*rd,y=cy+Math.sin(a)*rd;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      }
      ctx.closePath();ctx.stroke();
    }
    // Main waveform ring
    ctx.beginPath();
    ctx.strokeStyle='rgba(0,212,255,0.8)';
    ctx.lineWidth=2;
    ctx.shadowColor='#00d4ff';
    ctx.shadowBlur=15;
    const baseR=60;
    for(let i=0;i<=360;i+=1){
      const a=i*Math.PI/180;
      const idx=Math.floor(i/360*128);
      let amp;
      if(analyser){amp=(data[idx]||0)/255*35;}
      else{amp=Math.sin(t*3+i*0.08)*4+Math.sin(t*1.5+i*0.03)*3;}
      const rd=baseR+amp;
      const x=cx+Math.cos(a)*rd,y=cy+Math.sin(a)*rd;
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath();ctx.stroke();
    ctx.shadowBlur=0;
    // Center glow
    const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,40+Math.sin(t)*5);
    grd.addColorStop(0,'rgba(0,212,255,0.15)');
    grd.addColorStop(1,'rgba(0,212,255,0)');
    ctx.fillStyle=grd;
    ctx.beginPath();ctx.arc(cx,cy,40+Math.sin(t)*5,0,Math.PI*2);ctx.fill();
    // Inner ring
    ctx.beginPath();
    ctx.strokeStyle='rgba(0,212,255,0.3)';
    ctx.lineWidth=1;
    ctx.arc(cx,cy,30,0,Math.PI*2);
    ctx.stroke();
    // Tick marks
    for(let i=0;i<12;i++){
      const a=i*30*Math.PI/180+t*0.5;
      ctx.beginPath();
      ctx.strokeStyle='rgba(0,212,255,0.2)';
      ctx.moveTo(cx+Math.cos(a)*44,cy+Math.sin(a)*44);
      ctx.lineTo(cx+Math.cos(a)*52,cy+Math.sin(a)*52);
      ctx.stroke();
    }
  }
  draw();
}

// ─── Particles ───
function initParticles(){
  const c=$('particle-canvas'),x=c.getContext('2d');
  c.width=window.innerWidth;c.height=window.innerHeight;
  const pts=[];
  for(let i=0;i<50;i++)pts.push({x:Math.random()*c.width,y:Math.random()*c.height,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,r:Math.random()*2+.5,o:Math.random()*.3+.1});
  function draw(){
    requestAnimationFrame(draw);
    x.clearRect(0,0,c.width,c.height);
    for(const p of pts){
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;
      if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;
      x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);
      x.fillStyle=`rgba(0,212,255,${p.o})`;x.fill();
    }
    // Connect nearby
    for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){
      const d=Math.hypot(pts[i].x-pts[j].x,pts[i].y-pts[j].y);
      if(d<150){x.beginPath();x.strokeStyle=`rgba(0,212,255,${0.05*(1-d/150)})`;x.moveTo(pts[i].x,pts[i].y);x.lineTo(pts[j].x,pts[j].y);x.stroke();}
    }
  }
  draw();
  window.addEventListener('resize',()=>{c.width=window.innerWidth;c.height=window.innerHeight});
}

// ─── Grid Background ───
function initGrid(){
  const c=$('grid-canvas'),x=c.getContext('2d');
  c.width=window.innerWidth;c.height=window.innerHeight;
  x.strokeStyle='rgba(0,212,255,0.15)';x.lineWidth=.5;
  const s=60;
  for(let i=0;i<c.width;i+=s){x.beginPath();x.moveTo(i,0);x.lineTo(i,c.height);x.stroke();}
  for(let i=0;i<c.height;i+=s){x.beginPath();x.moveTo(0,i);x.lineTo(c.width,i);x.stroke();}
  window.addEventListener('resize',()=>{c.width=window.innerWidth;c.height=window.innerHeight;initGrid()});
}
</script>
</body>
</html>
